<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Analytics Pro</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 40px;
        }

        /* --- Layout & Header --- */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 15px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand i {
            font-size: 24px;
            color: var(--primary);
        }

        .brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
        }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* --- Filters Section --- */
        .filters-wrapper {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        select, input[type="date"] {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background-color: #fff;
            color: var(--text-main);
            min-width: 140px;
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            border-color: var(--primary);
        }

        /* --- Buttons --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { filter: brightness(90%); }

        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { filter: brightness(90%); }

        .btn-outline { 
            background: transparent; 
            border: 1px solid var(--border); 
            color: var(--text-main);
        }
        .btn-outline:hover { background: #f9fafb; border-color: var(--text-light); }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
        }
        .file-input-wrapper input {
            position: absolute;
            left: 0; top: 0; opacity: 0;
            width: 100%; height: 100%;
            cursor: pointer;
        }

        /* --- Data Validation Alerts --- */
        .alert-container {
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: var(--radius);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid var(--warning);
            color: #92400e;
        }

        .alert-error {
            background: #fee2e2;
            border-left: 4px solid var(--danger);
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid var(--primary);
            color: #1e40af;
        }

        /* --- Stats Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: var(--primary);
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .stat-sub {
            font-size: 0.8rem;
            margin-top: 8px;
        }
        .stat-sub.up { color: var(--success); }
        .stat-sub.down { color: var(--danger); }

        /* --- Charts Grid --- */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* --- Courier Ranking Table --- */
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .ranking-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .ranking-table tr:hover {
            background: #f9fafb;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .rank-1 { background: #fbbf24; color: white; }
        .rank-2 { background: #d1d5db; color: #374151; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #e5e7eb; color: #6b7280; }

        /* --- Data Table --- */
        .table-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 250px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 12px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-light);
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #f3f4f6;
            color: var(--primary);
        }

        th i {
            margin-left: 5px;
            font-size: 0.8em;
            opacity: 0.5;
        }

        td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background: #f9fafb; }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* Pagination Controls */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 15px 20px;
            gap: 15px;
            border-top: 1px solid var(--border);
        }
        
        .page-info {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .page-btn:hover:not(:disabled) {
            background: #f3f4f6;
            color: var(--primary);
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .notification.show { transform: translateY(0); }
        .notification.success { background-color: var(--success); }
        .notification.error { background-color: var(--danger); }
        .notification.info { background-color: var(--primary); }
        .notification.warning { background-color: var(--warning); }

        /* Insights Card */
        .insights-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: var(--radius);
            margin-bottom: 24px;
        }

        .insights-card h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .insight-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-item i {
            font-size: 1.5rem;
        }

        @media (max-width: 1024px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .top-bar { flex-direction: column; align-items: stretch; }
            .filters-wrapper { flex-direction: column; align-items: stretch; }
            .search-input { width: 100%; margin-top: 10px; }
            .table-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Top Header -->
    <div class="top-bar">
        <div class="brand">
            <i class="fas fa-truck-fast"></i>
            <h1>Delivery Analytics Pro</h1>
        </div>
        <div class="actions" style="display: flex; gap: 10px;">
            <div class="file-input-wrapper btn btn-primary">
                <i class="fas fa-cloud-upload-alt"></i> Upload Excel
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
            </div>
            <button class="btn btn-success" onclick="exportData()">
                <i class="fas fa-file-export"></i> Export
            </button>
            <button class="btn btn-danger" onclick="clearAllData()">
                <i class="fas fa-trash-alt"></i> Reset
            </button>
        </div>
    </div>

    <!-- Data Validation Alerts -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">
            <i class="fas fa-chart-line"></i> Overview
        </button>
        <button class="tab" onclick="switchTab('comparison')">
            <i class="fas fa-arrows-left-right"></i> Comparison
        </button>
        <button class="tab" onclick="switchTab('ranking')">
            <i class="fas fa-trophy"></i> Courier Ranking
        </button>
        <button class="tab" onclick="switchTab('insights')">
            <i class="fas fa-lightbulb"></i> Insights
        </button>
        <button class="tab" onclick="switchTab('data')">
            <i class="fas fa-table"></i> Data Table
        </button>
    </div>

    <!-- TAB: Overview -->
    <div id="tab-overview" class="tab-content active">
        <!-- Filters -->
        <div class="filters-wrapper">
            <div class="filter-group">
                <label>Period</label>
                <select id="filterType" onchange="toggleDateInputs()">
                    <option value="this_month" selected>Current Month</option>
                    <option value="last_month">Last Month</option>
                    <option value="this_week">This Week</option>
                    <option value="last_week">Last Week</option>
                    <option value="all">All Time</option>
                    <option value="year">Specific Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>

            <div class="filter-group" id="yearSelectGroup" style="display:none;">
                <label>Select Year</label>
                <select id="filterYear" onchange="applyFilters()"></select>
            </div>

            <div class="filter-group" id="dateStartGroup" style="display:none;">
                <label>From</label>
                <input type="date" id="dateStart" onchange="applyFilters()">
            </div>

            <div class="filter-group" id="dateEndGroup" style="display:none;">
                <label>To</label>
                <input type="date" id="dateEnd" onchange="applyFilters()">
            </div>

            <div style="margin-left: auto;">
                 <button class="btn btn-outline" onclick="applyFilters()">
                    <i class="fas fa-filter"></i> Apply
                 </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- Charts Area -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Delivery Trends</h3>
                    <i class="fas fa-chart-line" style="color: var(--secondary)"></i>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Weekday Efficiency</h3>
                    <i class="fas fa-calendar-week" style="color: var(--secondary)"></i>
                </div>
                <div class="chart-container">
                    <canvas id="weekdayChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Top 10 Couriers</h3>
                    <i class="fas fa-trophy" style="color: var(--warning)"></i>
                </div>
                <div class="chart-container">
                    <canvas id="courierChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Delivery Status</h3>
                    <i class="fas fa-chart-pie" style="color: var(--secondary)"></i>
                </div>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Comparison -->
    <div id="tab-comparison" class="tab-content">
        <div class="filters-wrapper">
            <div class="filter-group">
                <label>Compare</label>
                <select id="comparisonType" onchange="updateComparison()">
                    <option value="wow">Week over Week</option>
                    <option value="mom">Month over Month</option>
                    <option value="yoy">Year over Year</option>
                </select>
            </div>
        </div>

        <div class="stats-grid" id="comparisonStats"></div>

        <div class="charts-grid">
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h3>Performance Comparison</h3>
                </div>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Courier Ranking -->
    <div id="tab-ranking" class="tab-content">
        <div class="chart-card">
            <div class="chart-header">
                <h3>Courier Performance Ranking</h3>
                <select id="rankingMetric" onchange="updateRanking()">
                    <option value="successRate">Success Rate</option>
                    <option value="totalDelivered">Total Delivered</option>
                    <option value="consistency">Consistency</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table class="ranking-table" id="rankingTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Courier Name</th>
                            <th>Total Parcels</th>
                            <th>Delivered</th>
                            <th>Success Rate</th>
                            <th>Avg Daily</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB: Insights -->
    <div id="tab-insights" class="tab-content">
        <div class="insights-card">
            <h3><i class="fas fa-lightbulb"></i> AI-Powered Insights</h3>
            <div id="insightsContent"></div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Trend Prediction</h3>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Performance Distribution</h3>
                </div>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: Data Table -->
    <div id="tab-data" class="tab-content">
        <div class="table-card">
            <div class="table-header">
                <h3>Detailed Report</h3>
                <input type="text" id="tableSearch" class="search-input" placeholder="Search courier, vehicle..." onkeyup="searchTable()">
            </div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'date')">Date <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(1, 'string')">Courier <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(2, 'string')">Vehicle <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(3, 'string')">Zone <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(4, 'number')">Loaded <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(5, 'number')">Delivered <i class="fas fa-sort"></i></th>
                            <th onclick="sortTable(6, 'number')">Success Rate <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <span class="page-info" id="pageInfo">Showing 0-0 of 0</span>
                <button class="page-btn" onclick="changePage(-1)" id="btnPrev">Prev</button>
                <button class="page-btn" onclick="changePage(1)" id="btnNext">Next</button>
            </div>
        </div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
    // --- State Management ---
    let state = {
        allData: [],
        filteredData: [],
        displayData: [],
        charts: {},
        currentPage: 1,
        rowsPerPage: 50,
        activeTab: 'overview',
        validationIssues: []
    };

    // --- Initialization ---
    window.addEventListener('load', () => {
        initUI();
        loadData();
    });

    function initUI() {
        document.getElementById('filterType').value = 'this_month';
        toggleDateInputs();
        
        // Chart.js defaults
        if (typeof Chart !== 'undefined') {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#6b7280';
            if (Chart.defaults.scale && Chart.defaults.scale.grid) {
                Chart.defaults.scale.grid.color = '#f3f4f6';
            }
        }
    }

    // --- Data Validation ---
    function validateData(data) {
        const issues = [];
        const seenKeys = new Set();
        const duplicates = [];
        let missingDates = 0;
        let missingCouriers = 0;
        let invalidValues = 0;

        data.forEach((row, idx) => {
            // Check for duplicates (same date + courier + loaded count)
            const key = `${row._dateStr}_${row["ПІБ кур'єра"]}_${row._loaded}`;
            if (seenKeys.has(key)) {
                duplicates.push(idx);
            }
            seenKeys.add(key);

            // Check for missing data
            if (!row._dateObj) missingDates++;
            if (!row["ПІБ кур'єра"] || row["ПІБ кур'єра"].trim() === '') missingCouriers++;
            if (row._delivered > row._loaded) invalidValues++;
        });

        if (duplicates.length > 0) {
            issues.push({
                type: 'warning',
                message: `Found ${duplicates.length} potential duplicate entries`,
                icon: 'fa-clone'
            });
        }

        if (missingDates > 0) {
            issues.push({
                type: 'error',
                message: `${missingDates} records with invalid/missing dates`,
                icon: 'fa-calendar-xmark'
            });
        }

        if (missingCouriers > 0) {
            issues.push({
                type: 'warning',
                message: `${missingCouriers} records with missing courier names`,
                icon: 'fa-user-xmark'
            });
        }

        if (invalidValues > 0) {
            issues.push({
                type: 'error',
                message: `${invalidValues} records where delivered > loaded (data error)`,
                icon: 'fa-triangle-exclamation'
            });
        }

        return issues;
    }

    function displayValidationAlerts(issues) {
        const container = document.getElementById('alertContainer');
        
        if (issues.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = issues.map(issue => `
            <div class="alert alert-${issue.type}">
                <i class="fas ${issue.icon}"></i>
                <div>
                    <strong>${issue.type === 'error' ? 'Error' : 'Warning'}:</strong>
                    ${issue.message}
                </div>
            </div>
        `).join('');
    }

    // --- Tab Switching ---
    function switchTab(tabName) {
        state.activeTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.closest('.tab').classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Update content based on tab
        if (tabName === 'comparison') updateComparison();
        if (tabName === 'ranking') updateRanking();
        if (tabName === 'insights') updateInsights();
        if (tabName === 'data') searchTable();
    }

    // --- Data Loading & Parsing ---
    function loadData() {
        const stored = localStorage.getItem('deliveryDataV4');
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                state.allData = parsed.map(restoreRowData);
                
                // Validate data
                state.validationIssues = validateData(state.allData);
                displayValidationAlerts(state.validationIssues);
                
                populateYearFilter();
                applyFilters();
                showToast(`Loaded ${state.allData.length} records`, 'info');
            } catch (e) {
                console.error("Data load error", e);
                localStorage.removeItem('deliveryDataV4');
            }
        } else {
            updateDashboard();
        }
    }

    function restoreRowData(row) {
        return {
            ...row,
            _dateObj: row._dateStr ? new Date(row._dateStr) : null
        };
    }

    function parseDateCustom(rawDate) {
        if (!rawDate) return null;
        
        if (typeof rawDate === 'number') {
            return new Date(Math.round((rawDate - 25569) * 86400 * 1000));
        }
        
        if (typeof rawDate === 'string') {
            const cleanStr = rawDate.trim();
            const europeanDatePattern = /^(\d{1,2})[-.](\d{1,2})[-.](\d{4})/;
            const match = cleanStr.match(europeanDatePattern);
            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10) - 1;
                const year = parseInt(match[3], 10);
                return new Date(year, month, day);
            }
            const standardDate = new Date(cleanStr);
            if (!isNaN(standardDate)) return standardDate;
        }
        return null;
    }

    function enhanceRowData(row) {
        const dateObj = parseDateCustom(row['Дата відомості']);
        
        return {
            ...row,
            _dateObj: dateObj,
            _dateStr: dateObj ? dateObj.toISOString() : null,
            _loaded: Number(row['К-сть завантажених ШК'] || 0),
            _delivered: Number(row['К-сть доставлених ШК на дату відомості'] || 0)
        };
    }

    // --- File Upload Handler ---
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                let processedCount = 0;
                let errorCount = 0;

                const cleanData = jsonData
                    .filter(r => {
                        const isTotalRow = r['№'] === 'ВСЬОГО' || r['№'] === 'Total';
                        const hasLoad = r['К-сть завантажених ШК'] !== undefined;
                        return !isTotalRow && hasLoad;
                    })
                    .map(r => {
                        const enhanced = enhanceRowData(r);
                        if (enhanced._dateObj) {
                            processedCount++;
                            return enhanced;
                        } else {
                            errorCount++;
                            return null;
                        }
                    })
                    .filter(r => r !== null);

                state.allData = [...state.allData, ...cleanData];
                state.allData.sort((a, b) => b._dateObj - a._dateObj);

                // Validate and display issues
                state.validationIssues = validateData(state.allData);
                displayValidationAlerts(state.validationIssues);

                localStorage.setItem('deliveryDataV4', JSON.stringify(state.allData));
                
                populateYearFilter();
                applyFilters();
                
                if (errorCount > 0) {
                    showToast(`Loaded: ${processedCount}. Skipped: ${errorCount}`, 'warning');
                } else {
                    showToast(`Successfully added ${processedCount} records!`, 'success');
                }

            } catch (err) {
                console.error(err);
                showToast('Error reading file: ' + err.message, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // --- Filtering Logic ---
    function populateYearFilter() {
        const years = [...new Set(state.allData
            .filter(d => d._dateObj)
            .map(d => d._dateObj.getFullYear())
        )].sort().reverse();
        
        const select = document.getElementById('filterYear');
        select.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function toggleDateInputs() {
        const type = document.getElementById('filterType').value;
        document.getElementById('yearSelectGroup').style.display = type === 'year' ? 'flex' : 'none';
        document.getElementById('dateStartGroup').style.display = type === 'custom' ? 'flex' : 'none';
        document.getElementById('dateEndGroup').style.display = type === 'custom' ? 'flex' : 'none';
        
        if (type !== 'custom') applyFilters();
    }

    function getWeekBounds(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday
        const monday = new Date(d.setDate(diff));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        return { start: monday, end: sunday };
    }

    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const now = new Date();
        
        state.filteredData = state.allData.filter(item => {
            if (!item._dateObj) return false;
            const d = item._dateObj;

            switch (type) {
                case 'all': 
                    return true;
                case 'this_month':
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                case 'last_month':
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    return d.getMonth() === lastMonth.getMonth() && d.getFullYear() === lastMonth.getFullYear();
                case 'this_week':
                    const thisWeek = getWeekBounds(now);
                    return d >= thisWeek.start && d <= thisWeek.end;
                case 'last_week':
                    const lastWeekDate = new Date(now);
                    lastWeekDate.setDate(now.getDate() - 7);
                    const lastWeek = getWeekBounds(lastWeekDate);
                    return d >= lastWeek.start && d <= lastWeek.end;
                case 'year':
                    const selectedYear = parseInt(document.getElementById('filterYear').value) || now.getFullYear();
                    return d.getFullYear() === selectedYear;
                case 'custom':
                    const sStr = document.getElementById('dateStart').value;
                    const eStr = document.getElementById('dateEnd').value;
                    if (!sStr || !eStr) return true;
                    const start = new Date(sStr);
                    const end = new Date(eStr);
                    end.setHours(23,59,59);
                    return d >= start && d <= end;
                default: 
                    return true;
            }
        });

        state.currentPage = 1;
        updateDashboard();
    }

    // --- Dashboard Updating ---
    function updateDashboard() {
        if (state.activeTab === 'overview') {
            updateStats();
            updateCharts();
        }
        searchTable();
    }

    function updateStats() {
        const data = state.filteredData;
        const totalLoaded = data.reduce((s, i) => s + i._loaded, 0);
        const totalDelivered = data.reduce((s, i) => s + i._delivered, 0);
        const rate = totalLoaded ? (totalDelivered / totalLoaded * 100).toFixed(1) : 0;
        
        const uniqueCouriers = new Set(data.map(d => d["ПІБ кур'єра"])).size;
        const uniqueDays = new Set(data.map(d => d._dateStr?.split('T')[0])).size;

        const div = document.getElementById('statsGrid');
        div.innerHTML = `
            <div class="stat-card">
                <span class="stat-label">Total Parcels</span>
                <span class="stat-value">${totalLoaded.toLocaleString()}</span>
                <span class="stat-sub">Loaded in period</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Delivered</span>
                <span class="stat-value">${totalDelivered.toLocaleString()}</span>
                <span class="stat-sub up"><i class="fas fa-check-circle"></i> ${rate}% success</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Active Couriers</span>
                <span class="stat-value">${uniqueCouriers}</span>
                <span class="stat-sub">In this period</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Delivery Days</span>
                <span class="stat-value">${uniqueDays}</span>
                <span class="stat-sub">Days with activity</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Failed/Returned</span>
                <span class="stat-value">${(totalLoaded - totalDelivered).toLocaleString()}</span>
                <span class="stat-sub down">${(100 - rate).toFixed(1)}% of total</span>
            </div>
        `;
    }

    function updateCharts() {
        const data = state.filteredData;
        
        // Destroy existing charts
        Object.values(state.charts).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') chart.destroy();
        });
        state.charts = {};

        if (data.length === 0) return;

        // 1. Timeline Chart
        const timelineMap = {};
        data.forEach(item => {
            const dateKey = item._dateStr?.split('T')[0] || 'unknown';
            if (!timelineMap[dateKey]) {
                timelineMap[dateKey] = { l: 0, d: 0 };
            }
            timelineMap[dateKey].l += item._loaded;
            timelineMap[dateKey].d += item._delivered;
        });

        const sortedKeys = Object.keys(timelineMap).sort();
        const displayLabels = sortedKeys.map(k => {
            const parts = k.split('-');
            return `${parts[2]}.${parts[1]}`;
        });

        const ctx1 = document.getElementById('timelineChart');
        if (ctx1) {
            state.charts.timeline = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: displayLabels,
                    datasets: [
                        { 
                            label: 'Loaded', 
                            data: sortedKeys.map(k => timelineMap[k].l), 
                            borderColor: '#9ca3af', 
                            tension: 0.3, 
                            borderWidth: 2, 
                            pointRadius: 3 
                        },
                        { 
                            label: 'Delivered', 
                            data: sortedKeys.map(k => timelineMap[k].d), 
                            borderColor: '#4f46e5', 
                            tension: 0.3, 
                            borderWidth: 2, 
                            backgroundColor: 'rgba(79, 70, 229, 0.1)', 
                            fill: true,
                            pointRadius: 3
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: true } } 
                }
            });
        }

        // 2. Weekday Chart
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const dayStats = days.map(() => ({l:0, d:0}));
        
        data.forEach(item => {
            let jsDay = item._dateObj.getDay();
            let chartIdx = (jsDay + 6) % 7;
            dayStats[chartIdx].l += item._loaded;
            dayStats[chartIdx].d += item._delivered;
        });

        const dayRates = dayStats.map(s => s.l > 0 ? (s.d / s.l * 100) : 0);

        const ctx2 = document.getElementById('weekdayChart');
        if (ctx2) {
            state.charts.weekday = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Success Rate %',
                        data: dayRates,
                        backgroundColor: dayRates.map(v => v > 90 ? '#10b981' : v > 80 ? '#f59e0b' : '#ef4444'),
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true, max: 100 } } 
                }
            });
        }

        // 3. Top Couriers Chart
        const courierMap = {};
        data.forEach(d => {
            const name = d["ПІБ кур'єра"] || 'Unknown';
            if (!courierMap[name]) courierMap[name] = 0;
            courierMap[name] += d._delivered;
        });
        const sortedCouriers = Object.entries(courierMap).sort((a,b) => b[1] - a[1]).slice(0, 10);

        const ctx3 = document.getElementById('courierChart');
        if (ctx3) {
            state.charts.courier = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: sortedCouriers.map(i => i[0].split(' ')[0]),
                    datasets: [{
                        label: 'Delivered',
                        data: sortedCouriers.map(i => i[1]),
                        backgroundColor: '#4f46e5',
                        borderRadius: 4
                    }]
                },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } } 
                }
            });
        }

        // 4. Pie Chart
        const totalL = data.reduce((s, i) => s + i._loaded, 0);
        const totalD = data.reduce((s, i) => s + i._delivered, 0);
        const ctx4 = document.getElementById('pieChart');
        if (ctx4) {
            state.charts.pie = new Chart(ctx4, {
                type: 'doughnut',
                data: {
                    labels: ['Delivered', 'Returned/Failed'],
                    datasets: [{
                        data: [totalD, totalL - totalD],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '70%' 
                }
            });
        }
    }

    // --- Comparison View ---
    function updateComparison() {
        const type = document.getElementById('comparisonType').value;
        const now = new Date();
        
        let current, previous, currentLabel, previousLabel;

        if (type === 'wow') {
            // This week vs last week
            const thisWeek = getWeekBounds(now);
            const lastWeekDate = new Date(now);
            lastWeekDate.setDate(now.getDate() - 7);
            const lastWeek = getWeekBounds(lastWeekDate);
            
            current = state.allData.filter(d => d._dateObj >= thisWeek.start && d._dateObj <= thisWeek.end);
            previous = state.allData.filter(d => d._dateObj >= lastWeek.start && d._dateObj <= lastWeek.end);
            currentLabel = 'This Week';
            previousLabel = 'Last Week';
        } else if (type === 'mom') {
            // This month vs last month
            current = state.allData.filter(d => 
                d._dateObj && d._dateObj.getMonth() === now.getMonth() && d._dateObj.getFullYear() === now.getFullYear()
            );
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            previous = state.allData.filter(d => 
                d._dateObj && d._dateObj.getMonth() === lastMonth.getMonth() && d._dateObj.getFullYear() === lastMonth.getFullYear()
            );
            currentLabel = 'This Month';
            previousLabel = 'Last Month';
        } else {
            // This year vs last year
            current = state.allData.filter(d => d._dateObj && d._dateObj.getFullYear() === now.getFullYear());
            previous = state.allData.filter(d => d._dateObj && d._dateObj.getFullYear() === now.getFullYear() - 1);
            currentLabel = now.getFullYear().toString();
            previousLabel = (now.getFullYear() - 1).toString();
        }

        const currentStats = calculatePeriodStats(current);
        const previousStats = calculatePeriodStats(previous);

        // Display comparison stats
        const statsDiv = document.getElementById('comparisonStats');
        statsDiv.innerHTML = `
            <div class="stat-card">
                <span class="stat-label">Parcels - ${currentLabel}</span>
                <span class="stat-value">${currentStats.loaded.toLocaleString()}</span>
                <span class="stat-sub ${currentStats.loaded >= previousStats.loaded ? 'up' : 'down'}">
                    ${currentStats.loaded >= previousStats.loaded ? '↑' : '↓'} 
                    ${((currentStats.loaded - previousStats.loaded) / previousStats.loaded * 100 || 0).toFixed(1)}% vs ${previousLabel}
                </span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Delivered - ${currentLabel}</span>
                <span class="stat-value">${currentStats.delivered.toLocaleString()}</span>
                <span class="stat-sub ${currentStats.delivered >= previousStats.delivered ? 'up' : 'down'}">
                    ${currentStats.delivered >= previousStats.delivered ? '↑' : '↓'} 
                    ${((currentStats.delivered - previousStats.delivered) / previousStats.delivered * 100 || 0).toFixed(1)}% vs ${previousLabel}
                </span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Success Rate - ${currentLabel}</span>
                <span class="stat-value">${currentStats.rate.toFixed(1)}%</span>
                <span class="stat-sub ${currentStats.rate >= previousStats.rate ? 'up' : 'down'}">
                    ${currentStats.rate >= previousStats.rate ? '↑' : '↓'} 
                    ${(currentStats.rate - previousStats.rate).toFixed(1)}pp vs ${previousLabel}
                </span>
            </div>
        `;

        // Update comparison chart
        if (state.charts.comparison) state.charts.comparison.destroy();
        
        const ctx = document.getElementById('comparisonChart');
        if (ctx) {
            state.charts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Loaded', 'Delivered', 'Success Rate (%)'],
                    datasets: [
                        {
                            label: previousLabel,
                            data: [previousStats.loaded, previousStats.delivered, previousStats.rate],
                            backgroundColor: '#9ca3af'
                        },
                        {
                            label: currentLabel,
                            data: [currentStats.loaded, currentStats.delivered, currentStats.rate],
                            backgroundColor: '#4f46e5'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } }
                }
            });
        }
    }

    function calculatePeriodStats(data) {
        const loaded = data.reduce((s, i) => s + i._loaded, 0);
        const delivered = data.reduce((s, i) => s + i._delivered, 0);
        const rate = loaded ? (delivered / loaded * 100) : 0;
        return { loaded, delivered, rate };
    }

    // --- Courier Ranking ---
    function updateRanking() {
        const metric = document.getElementById('rankingMetric').value;
        const courierStats = {};

        state.filteredData.forEach(d => {
            const name = d["ПІБ кур'єра"] || 'Unknown';
            if (!courierStats[name]) {
                courierStats[name] = {
                    loaded: 0,
                    delivered: 0,
                    days: new Set()
                };
            }
            courierStats[name].loaded += d._loaded;
            courierStats[name].delivered += d._delivered;
            courierStats[name].days.add(d._dateStr?.split('T')[0]);
        });

        // Calculate metrics and sort
        let rankings = Object.entries(courierStats).map(([name, stats]) => {
            const successRate = stats.loaded > 0 ? (stats.delivered / stats.loaded * 100) : 0;
            const avgDaily = stats.days.size > 0 ? (stats.delivered / stats.days.size) : 0;
            const consistency = calculateConsistency(name);
            
            return {
                name,
                loaded: stats.loaded,
                delivered: stats.delivered,
                successRate,
                avgDaily: avgDaily.toFixed(1),
                consistency,
                days: stats.days.size
            };
        });

        // Sort based on selected metric
        if (metric === 'successRate') {
            rankings.sort((a, b) => b.successRate - a.successRate);
        } else if (metric === 'totalDelivered') {
            rankings.sort((a, b) => b.delivered - a.delivered);
        } else {
            rankings.sort((a, b) => b.consistency - a.consistency);
        }

        // Display ranking table
        const tbody = document.getElementById('rankingBody');
        tbody.innerHTML = rankings.map((courier, idx) => {
            const rank = idx + 1;
            const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
            const performanceBar = `<div style="background: #e5e7eb; border-radius: 4px; height: 8px; width: 100px;">
                <div style="background: #10b981; height: 100%; width: ${courier.successRate}%; border-radius: 4px;"></div>
            </div>`;

            return `
                <tr>
                    <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                    <td style="font-weight: 500">${courier.name}</td>
                    <td>${courier.loaded.toLocaleString()}</td>
                    <td>${courier.delivered.toLocaleString()}</td>
                    <td><span class="badge badge-${courier.successRate >= 95 ? 'success' : courier.successRate >= 85 ? 'warning' : 'danger'}">${courier.successRate.toFixed(1)}%</span></td>
                    <td>${courier.avgDaily}</td>
                    <td>${performanceBar}</td>
                </tr>
            `;
        }).join('');
    }

    function calculateConsistency(courierName) {
        const deliveries = state.filteredData
            .filter(d => d["ПІБ кур'єра"] === courierName)
            .map(d => d._loaded > 0 ? (d._delivered / d._loaded * 100) : 0);
        
        if (deliveries.length < 2) return 0;
        
        const mean = deliveries.reduce((a, b) => a + b, 0) / deliveries.length;
        const variance = deliveries.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / deliveries.length;
        const stdDev = Math.sqrt(variance);
        
        // Lower standard deviation = higher consistency
        // Convert to 0-100 scale (100 = perfect consistency)
        return Math.max(0, 100 - stdDev);
    }

    // --- Insights & Predictions ---
    function updateInsights() {
        const insights = generateInsights();
        
        const container = document.getElementById('insightsContent');
        container.innerHTML = insights.map(insight => `
            <div class="insight-item">
                <i class="fas ${insight.icon}"></i>
                <div>
                    <strong>${insight.title}</strong><br>
                    ${insight.description}
                </div>
            </div>
        `).join('');

        // Update trend chart
        updateTrendChart();
        updateDistributionChart();
    }

    function generateInsights() {
        const insights = [];
        const data = state.filteredData;
        
        if (data.length === 0) return [{ icon: 'fa-info-circle', title: 'No Data', description: 'Upload data to see insights' }];

        // 1. Best Day Analysis
        const dayStats = {};
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        data.forEach(d => {
            const day = d._dateObj.getDay();
            if (!dayStats[day]) dayStats[day] = { loaded: 0, delivered: 0 };
            dayStats[day].loaded += d._loaded;
            dayStats[day].delivered += d._delivered;
        });
        
        const bestDay = Object.entries(dayStats)
            .map(([day, stats]) => ({ day: parseInt(day), rate: stats.loaded > 0 ? stats.delivered / stats.loaded : 0 }))
            .sort((a, b) => b.rate - a.rate)[0];
        
        insights.push({
            icon: 'fa-calendar-check',
            title: 'Best Delivery Day',
            description: `${days[bestDay.day]} has the highest success rate at ${(bestDay.rate * 100).toFixed(1)}%`
        });

        // 2. Top Performer
        const courierStats = {};
        data.forEach(d => {
            const name = d["ПІБ кур'єра"] || 'Unknown';
            if (!courierStats[name]) courierStats[name] = { loaded: 0, delivered: 0 };
            courierStats[name].loaded += d._loaded;
            courierStats[name].delivered += d._delivered;
        });
        
        const topCourier = Object.entries(courierStats)
            .map(([name, stats]) => ({ name, rate: stats.loaded > 0 ? stats.delivered / stats.loaded : 0, delivered: stats.delivered }))
            .sort((a, b) => b.rate - a.rate)[0];
        
        insights.push({
            icon: 'fa-star',
            title: 'Top Performer',
            description: `${topCourier.name} leads with ${(topCourier.rate * 100).toFixed(1)}% success rate and ${topCourier.delivered} deliveries`
        });

        // 3. Trend Analysis
        const recent = data.slice(0, Math.floor(data.length / 2));
        const older = data.slice(Math.floor(data.length / 2));
        
        const recentRate = recent.reduce((s, d) => s + d._delivered, 0) / recent.reduce((s, d) => s + d._loaded, 0) * 100;
        const olderRate = older.reduce((s, d) => s + d._delivered, 0) / older.reduce((s, d) => s + d._loaded, 0) * 100;
        
        const trend = recentRate > olderRate ? 'improving' : 'declining';
        const change = Math.abs(recentRate - olderRate).toFixed(1);
        
        insights.push({
            icon: trend === 'improving' ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down',
            title: 'Performance Trend',
            description: `Delivery success is ${trend} by ${change}% compared to earlier period`
        });

        // 4. Volume Insight
        const avgDaily = data.reduce((s, d) => s + d._loaded, 0) / new Set(data.map(d => d._dateStr?.split('T')[0])).size;
        insights.push({
            icon: 'fa-box',
            title: 'Daily Average',
            description: `Processing ${avgDaily.toFixed(0)} parcels per day on average`
        });

        return insights;
    }

    function updateTrendChart() {
        if (state.charts.trend) state.charts.trend.destroy();
        
        const data = state.filteredData;
        if (data.length < 7) return;

        // Group by week and calculate moving average
        const weeklyData = [];
        const sortedData = [...data].sort((a, b) => a._dateObj - b._dateObj);
        
        for (let i = 0; i < sortedData.length; i += 7) {
            const week = sortedData.slice(i, i + 7);
            const loaded = week.reduce((s, d) => s + d._loaded, 0);
            const delivered = week.reduce((s, d) => s + d._delivered, 0);
            const rate = loaded > 0 ? (delivered / loaded * 100) : 0;
            weeklyData.push(rate);
        }

        // Simple linear regression for trend line
        const n = weeklyData.length;
        const sumX = (n * (n + 1)) / 2;
        const sumY = weeklyData.reduce((a, b) => a + b, 0);
        const sumXY = weeklyData.reduce((sum, y, x) => sum + (x + 1) * y, 0);
        const sumX2 = (n * (n + 1) * (2 * n + 1)) / 6;
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        const trendLine = weeklyData.map((_, i) => slope * (i + 1) + intercept);

        const ctx = document.getElementById('trendChart');
        if (ctx) {
            state.charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeklyData.map((_, i) => `Week ${i + 1}`),
                    datasets: [
                        {
                            label: 'Success Rate',
                            data: weeklyData,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Trend',
                            data: trendLine,
                            borderColor: '#ef4444',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } }
                }
            });
        }
    }

    function updateDistributionChart() {
        if (state.charts.distribution) state.charts.distribution.destroy();
        
        const data = state.filteredData;
        const rates = data.map(d => d._loaded > 0 ? (d._delivered / d._loaded * 100) : 0);
        
        // Create histogram bins
        const bins = [0, 50, 60, 70, 80, 85, 90, 95, 100];
        const counts = new Array(bins.length - 1).fill(0);
        
        rates.forEach(rate => {
            for (let i = 0; i < bins.length - 1; i++) {
                if (rate >= bins[i] && rate < bins[i + 1]) {
                    counts[i]++;
                    break;
                }
            }
        });

        const ctx = document.getElementById('distributionChart');
        if (ctx) {
            state.charts.distribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.slice(0, -1).map((b, i) => `${b}-${bins[i + 1]}%`),
                    datasets: [{
                        label: 'Number of Deliveries',
                        data: counts,
                        backgroundColor: '#4f46e5'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }
    }

    // --- Table & Pagination ---
    function searchTable() {
        const search = document.getElementById('tableSearch').value.toLowerCase();
        
        state.displayData = state.filteredData.filter(r => {
            if (!search) return true;
            return (r["ПІБ кур'єра"]||'').toLowerCase().includes(search) || 
                   (r['Номер авто']||'').toLowerCase().includes(search);
        });

        state.currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (state.displayData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: var(--text-light)">No data found</td></tr>';
            updatePaginationInfo(0);
            return;
        }

        const start = (state.currentPage - 1) * state.rowsPerPage;
        const end = start + state.rowsPerPage;
        const pageItems = state.displayData.slice(start, end);

        pageItems.forEach(row => {
            const rate = row._loaded > 0 ? (row._delivered / row._loaded * 100).toFixed(1) : 0;
            let badgeClass = rate >= 95 ? 'badge-success' : (rate >= 85 ? 'badge-warning' : 'badge-danger');
            
            const dateStr = row._dateObj ? 
                `${String(row._dateObj.getDate()).padStart(2,'0')}.${String(row._dateObj.getMonth()+1).padStart(2,'0')}.${row._dateObj.getFullYear()}` : '-';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dateStr}</td>
                <td style="font-weight: 500">${row["ПІБ кур'єра"] || '?'}</td>
                <td>${row['Номер авто'] || '-'}</td>
                <td>${row['Підрозділ відомості'] || '-'}</td>
                <td>${row._loaded}</td>
                <td>${row._delivered}</td>
                <td><span class="badge ${badgeClass}">${rate}%</span></td>
            `;
            tbody.appendChild(tr);
        });

        updatePaginationInfo(state.displayData.length);
    }

    function updatePaginationInfo(totalItems) {
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const pageInfo = document.getElementById('pageInfo');

        if (totalItems === 0) {
            pageInfo.textContent = 'No records';
            btnPrev.disabled = true;
            btnNext.disabled = true;
            return;
        }

        const start = (state.currentPage - 1) * state.rowsPerPage + 1;
        const end = Math.min(start + state.rowsPerPage - 1, totalItems);
        const totalPages = Math.ceil(totalItems / state.rowsPerPage);

        pageInfo.textContent = `Showing ${start}-${end} of ${totalItems}`;
        
        btnPrev.disabled = state.currentPage === 1;
        btnNext.disabled = state.currentPage === totalPages;
    }

    function changePage(delta) {
        state.currentPage += delta;
        renderTable();
    }

    // Sort Function
    let sortDir = 1;
    let lastCol = -1;

    function sortTable(n, type) {
        if (lastCol === n) { sortDir *= -1; } 
        else { sortDir = 1; lastCol = n; }

        document.querySelectorAll('th i').forEach(i => i.className = 'fas fa-sort');
        const clickedHeaderIcon = document.querySelectorAll('th i')[n];
        if (clickedHeaderIcon) {
            clickedHeaderIcon.className = sortDir === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
        }

        state.displayData.sort((a, b) => {
            let x, y;

            if (n === 0) {
                x = a._dateObj ? a._dateObj.getTime() : 0;
                y = b._dateObj ? b._dateObj.getTime() : 0;
            } else if (n === 1) { x = a["ПІБ кур'єра"] || ''; y = b["ПІБ кур'єра"] || ''; }
            else if (n === 2) { x = a['Номер авто'] || ''; y = b['Номер авто'] || ''; }
            else if (n === 3) { x = a['Підрозділ відомості'] || ''; y = b['Підрозділ відомості'] || ''; }
            else if (n === 4) { x = a._loaded; y = b._loaded; }
            else if (n === 5) { x = a._delivered; y = b._delivered; }
            else if (n === 6) {
                x = a._loaded > 0 ? a._delivered/a._loaded : 0;
                y = b._loaded > 0 ? b._delivered/b._loaded : 0;
            }

            if (x < y) return -1 * sortDir;
            if (x > y) return 1 * sortDir;
            return 0;
        });

        renderTable();
    }

    // --- Utilities ---
    function showToast(msg, type = 'info') {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.className = `notification show ${type}`;
        setTimeout(() => notif.className = 'notification', 3500);
    }

    function clearAllData() {
        if(confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
            localStorage.removeItem('deliveryDataV4');
            state.allData = [];
            state.filteredData = [];
            state.displayData = [];
            state.validationIssues = [];
            displayValidationAlerts([]);
            location.reload();
        }
    }

    function exportData() {
        if (!state.filteredData.length) return showToast('No data to export', 'error');
        
        const wb = XLSX.utils.book_new();
        const exportData = state.filteredData.map(d => {
            const { _dateObj, _dateStr, _loaded, _delivered, ...rest } = d;
            return {
                Date: _dateObj ? _dateObj.toLocaleDateString() : '',
                Courier: rest["ПІБ кур'єра"] || '',
                Vehicle: rest['Номер авто'] || '',
                Zone: rest['Підрозділ відомості'] || '',
                Loaded: _loaded,
                Delivered: _delivered,
                'Success Rate': _loaded > 0 ? ((_delivered / _loaded) * 100).toFixed(2) + '%' : '0%'
            };
        });
        
        const ws = XLSX.utils.json_to_sheet(exportData);
        XLSX.utils.book_append_sheet(wb, ws, "Filtered Export");
        
        const fileName = `delivery_export_${document.getElementById('filterType').value}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showToast(`Exported ${state.filteredData.length} filtered records`, 'success');
    }
</script>
</body>
</html>